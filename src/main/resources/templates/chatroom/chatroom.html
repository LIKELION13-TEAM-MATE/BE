<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { margin:0; background:#f6f7f9; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; }
        .page { max-width: 420px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; }

        header { background:#fff; border-bottom:1px solid #eee; padding:12px 14px; }
        .top-row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
        .back { text-decoration:none; color:#111; font-size:18px; }
        .title { text-align:center; flex:1; }
        .project-name { font-size:12px; color:#777; margin:0; }
        .room-line { font-size:16px; font-weight:700; margin:2px 0 0; display:inline-block; }

        main { flex:1; padding:12px 12px 8px; overflow:auto; }

        .date-divider {
          text-align:center; color:#8a8f98; font-size:12px;
          margin:14px 0; position:relative;
        }
        .date-divider span { background:#f6f7f9; padding:0 10px; }
        .date-divider:before {
          content:""; position:absolute; left:0; right:0; top:50%;
          height:1px; background:#e5e7eb; z-index:-1;
        }

        .msg-row {
          display:flex;
          width:100%;
          gap:8px;
          margin:8px 0;
          align-items:flex-end;
        }
        .msg-row.other { justify-content:flex-start; }
        .msg-row.self  { justify-content:flex-end; }

        .avatar {
          width:34px; height:34px; border-radius:50%;
          display:flex; align-items:center; justify-content:center;
          color:#fff; font-weight:700; font-size:14px; flex:0 0 34px;
        }

        .bubble {
          max-width: 70%;
          padding:10px 12px;
          border-radius: 18px;
          line-height:1.35;
          font-size:14px;
          white-space:pre-wrap;
          word-break:break-word;
        }
        .bubble.other { background:#fff; border:1px solid #eee; border-bottom-left-radius:6px; }
        .bubble.self  { background:#3b82f6; color:#fff; border-bottom-right-radius:6px; }

        .time {
          font-size:11px; color:#8a8f98; min-width:52px;
          padding-bottom:2px;
        }
        .time.left { text-align:left; }
        .time.right { text-align:right; }

        footer { background:#fff; border-top:1px solid #eee; padding:10px; display:flex; gap:8px; }
        #content { flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:14px; font-size:14px; }
        .send-btn { border:none; background:#111; color:#fff; padding:0 14px; border-radius:14px; font-size:14px; cursor:pointer; }
    </style>
</head>

<body>
<div class="page">

    <header>
        <div class="top-row">
            <a class="back"
               th:href="@{/project/{projectId}/chatrooms(projectId=${projectId}, memberId=${memberId})}">&lt;</a>

            <div class="title">
                <p class="project-name" th:text="${projectName}">프로젝트명</p>

                <div>
          <span class="room-line"
                th:text="|${chatRoomName} • ${chatRoomMemberCount != null ? chatRoomMemberCount : 0}|">
            대화방 • 0
          </span>
                </div>
            </div>

            <div style="width:18px;"></div>
        </div>
    </header>

    <input type="hidden" id="chatRoomId" th:value="${chatRoomId}">
    <input type="hidden" id="memberId" th:value="${memberId}">
    <input type="hidden" id="roomPasswordHidden" th:value="${roomPassword}">

    <main id="chatBody"></main>

    <footer>
        <input id="content" placeholder="메시지 입력" />
        <button class="send-btn" type="button" onclick="sendMessage()">전송</button>
    </footer>
</div>

<script th:inline="javascript">
    const chatRoomId = [[${chatRoomId}]];
    const memberId = [[${memberId}]];

    function initialFromNickname(nickname){
      if(!nickname) return "";
      return nickname.trim().charAt(0).toUpperCase();
    }

    function avatarColorFromNickname(nickname){
      if(!nickname) return "#CCCCCC";
      const colors = ["#FFC107","#03A9F4","#4CAF50","#FF5722","#9C27B0","#00BCD4","#FFEB3B","#8BC34A","#E91E63","#673AB7"];
      let hash = 0;
      for (let i=0; i<nickname.length; i++) {
        hash = ((hash << 5) - hash) + nickname.charCodeAt(i);
        hash |= 0;
      }
      return colors[Math.abs(hash % colors.length)];
    }

    function extractDate(createdAt){
      if(!createdAt) return null;
      return String(createdAt).substring(0,10);
    }
    function extractHHMM(createdAt){
      if(!createdAt) return "00:00";
      return String(createdAt).substring(11,16);
    }

    function formatKoreanDate(yyyyMMdd){
      const [y,m,d] = yyyyMMdd.split("-").map(Number);
      return `${y}년 ${m}월 ${d}일`;
    }
    function formatKoreanTime(hhmm){
      const [hh, mm] = hhmm.split(":").map(Number);
      const isPm = hh >= 12;
      const prefix = isPm ? "오후" : "오전";
      let hour12 = hh % 12;
      if(hour12 === 0) hour12 = 12;
      return `${prefix} ${hour12}:${String(mm).padStart(2,"0")}`;
    }

    function appendDateDivider(container, dateStr){
      const div = document.createElement("div");
      div.className = "date-divider";
      const span = document.createElement("span");
      span.textContent = formatKoreanDate(dateStr);
      div.appendChild(span);
      container.appendChild(div);
    }

    function getSenderId(m){
      return (m.senderMemberId != null) ? m.senderMemberId : m.senderId;
    }

    function appendMessage(container, m){
      const senderId = getSenderId(m);
      const isMe = (Number(senderId) === Number(memberId));

      const row = document.createElement("div");
      row.className = `msg-row ${isMe ? "self" : "other"}`;

      const time = document.createElement("div");
      time.className = `time ${isMe ? "right" : "left"}`;
      time.textContent = formatKoreanTime(extractHHMM(m.createdAt));

      const bubble = document.createElement("div");
      bubble.className = `bubble ${isMe ? "self" : "other"}`;
      bubble.textContent = m.content ?? "";

      if(isMe){
        row.appendChild(time);
        row.appendChild(bubble);
      } else {
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.style.backgroundColor = avatarColorFromNickname(m.senderNickname || "");
        avatar.textContent = initialFromNickname(m.senderNickname || "");

        row.appendChild(avatar);
        row.appendChild(bubble);
        row.appendChild(time);
      }

      container.appendChild(row);
    }

    async function loadMessages() {
      const pw = document.getElementById("roomPasswordHidden")?.value?.trim();
      const url = pw
        ? `/api/v1/chatrooms/${chatRoomId}/messages?memberId=${memberId}&roomPassword=${encodeURIComponent(pw)}`
        : `/api/v1/chatrooms/${chatRoomId}/messages?memberId=${memberId}`;

      const chatBody = document.getElementById("chatBody");
      chatBody.innerHTML = "";

      const res = await fetch(url);
      if(!res.ok){
        chatBody.textContent = "메시지 조회 실패";
        return;
      }

      const data = await res.json();

      let lastDate = null;
      data.forEach(m => {
        const dateStr = extractDate(m.createdAt);
        if(dateStr && dateStr !== lastDate){
          appendDateDivider(chatBody, dateStr);
          lastDate = dateStr;
        }
        appendMessage(chatBody, m);
      });

      chatBody.scrollTop = chatBody.scrollHeight;
    }

    async function sendMessage() {
      const contentEl = document.getElementById("content");
      const content = contentEl.value.trim();
      const pw = document.getElementById("roomPasswordHidden")?.value?.trim();

      if(!content){
        alert("내용 입력해");
        return;
      }

      const res = await fetch(`/api/v1/chatrooms/${chatRoomId}/messages?senderMemberId=${memberId}`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ content, roomPassword: pw || null })
      });

      if(!res.ok){
        alert("전송 실패");
        return;
      }

      contentEl.value = "";
      await loadMessages();
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadMessages();
    });
</script>

</body>
</html>
