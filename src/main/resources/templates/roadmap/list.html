<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Î°úÎìúÎßµ</title>
</head>
<body>

<p>
    <a th:href="@{/home/main}">&lt;</a>
</p>
<h2 th:text="${project.projectName}">ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ</h2>

<p>
    <a th:href="@{/project/detail/{id}(id=${projectId})}">Í≤åÏãúÌåê</a> |
    <a th:href="@{/project/{id}/roles(id=${project.id})}">Ïó≠Ìï†</a> |
    <a th:href="@{/project/{projectId}/events/calendar(projectId=${projectId})}">ÏùºÏ†ï</a> |
    <span>Î°úÎìúÎßµ</span>
</p>
<hr/>

<div>
    <h3>
        Ï†ÑÏ≤¥ ÏßÑÌñâÎ•†: <span th:text="${totalProgress}">0</span>%
    </h3>

    <h3>
        <span th:text="${project.dDay}">(D-Day)</span>
    </h3>

    <p>
        Îã®Í≥Ñ <span th:text="${completedCount}">0</span> / <span th:text="${totalCount}">0</span>
    </p>

    <p>
        <a th:href="@{/project/{id}/roadmap/create(id=${project.id})}">Îã®Í≥Ñ Ï∂îÍ∞Ä</a>
    </p>
</div>
<hr/>

<!--Í∞Å Îã®Í≥Ñ-->
<div th:each="roadmap : ${roadmaps}">

    <div>
        <strong th:text="${roadmap.role}">1Îã®Í≥Ñ</strong>
        <h3><span th:text="${roadmap.title}">Í∏∞Ìöç</span></h3>
        <!--ÎèôÏóÖÏûê Ï†ïÎ≥¥-->
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <div th:each="rm : ${roadmap.members}" style="display: flex; align-items: center;">
                <div th:if="${rm.member.nickname != null}"
                     th:style="|background-color: ${rm.member.avatarColor};
                       width: 24px; height: 24px; border-radius: 50%;
                       display: flex; align-items: center; justify-content: center;
                       color: white; font-weight: bold; font-size: 0.8em; margin-right: 5px;|">
                    <span th:text="${rm.member.initial}"></span>
                </div>
                <span th:text="${rm.member.nickname}" style="font-size: 0.9em; color: #555;">Ïù¥Î¶Ñ</span>
            </div>
        </div>
        <!--ÏàòÏ†ï&ÏÇ≠Ï†ú-->
        <div>
            <a th:href="@{/roadmap/{rid}/edit(rid=${roadmap.id}, projectId=${project.id})}" style="text-decoration: none;">ÏàòÏ†ï</a>

            <form th:action="@{/roadmap/{rid}/delete(rid=${roadmap.id})}" method="post" style="display:inline;">
                <input type="hidden" name="projectId" th:value="${project.id}"/>
                <button type="submit" onclick="return confirm('Ïù¥ Îã®Í≥ÑÎ•º Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ìè¨Ìï®Îêú TaskÎèÑ Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§.')">
                    ÏÇ≠Ï†ú
                </button>
            </form>
        </div>
    </div>

    <div>
        <span>~</span><span th:text="${roadmap.deadline}">2025-11-11</span>
        <br/>
        <span>ÏßÑÌñâÎ•†: </span><span th:text="${roadmap.progress}">0</span>%
    </div>

    <!--Task-->
    <ul style="list-style: none; padding-left: 0;">
        <li th:each="task : ${roadmap.tasks}">

            <form th:action="@{/roadmap/{taskId}/check(taskId=${task.id})}" method="post" style="display:inline;">
                <input type="hidden" name="projectId" th:value="${project.id}"/>
                <button type="submit">
                    <span th:if="${task.checked}">‚úÖ</span>
                    <span th:unless="${task.checked}">‚¨ú</span>
                </button>
            </form>

            <span th:text="${task.content}">Ìï† Ïùº ÎÇ¥Ïö©</span>

            <!--Ï£ºÏÑù(Comment) ÏûÖÎ†• Î≤ÑÌäº-->
            <button type="button" th:onclick="'toggleNoteForm(' + ${task.id} + ')'">üí¨</button>

            <!--Task ÏÇ≠Ï†ú-->
            <form th:action="@{/roadmap/task/{taskId}/delete(taskId=${task.id})}" method="post" style="display:inline;">
                <input type="hidden" name="projectId" th:value="${project.id}"/>
                <button type="submit" onclick="return confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')">X</button>
            </form>

            <!--Ï£ºÏÑùÎÇ¥Ïö©-->
            <div th:if="${task.note != null && !task.note.isEmpty()}">
                <small><span th:text="${task.note}">ÎÇ¥Ïö©</span></small>
            </div>

            <!--Ï£ºÏÑù ÏûÖÎ†•ÎûÄ-->
            <div th:id="'noteForm-' + ${task.id}" style="display: none;">
                <form th:action="@{/roadmap/task/{taskId}/note(taskId=${task.id})}" method="post">
                    <input type="hidden" name="projectId" th:value="${project.id}"/>
                    <input type="text" name="note" th:value="${task.note}" placeholder="Ï£ºÏÑù ÏûÖÎ†•">
                    <button type="submit">Îì±Î°ù</button>
                </form>
            </div>
        </li>
    </ul>

    <!--Task ÏûÖÎ†•-->
    <form th:action="@{/roadmap/{rid}/task/add(rid=${roadmap.id})}" method="post">
        <input type="hidden" name="projectId" th:value="${project.id}"/>
        <input type="text" name="content" placeholder="ÏÑ∏Î∂Ä Task ÏûÖÎ†•" required>
        <button type="submit">Îì±Î°ù</button>
    </form>

    <hr/> </div>

<script>
    function toggleNoteForm(taskId) {
        var formDiv = document.getElementById('noteForm-' + taskId);
        if (formDiv.style.display === 'none') {
            formDiv.style.display = 'block';
        } else {
            formDiv.style.display = 'none';
        }
    }
</script>

</body>
</html>