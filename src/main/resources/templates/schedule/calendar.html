<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>일정</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f7;
        }
        .page {
            max-width: 420px;
            margin: 0 auto;
            background-color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
        }
        .back-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .back-row a {
            text-decoration: none;
            color: #333;
        }
        .project-title {
            margin-top: 4px;
        }
        .project-title h2 {
            margin: 0;
            font-size: 18px;
        }
        .project-title span {
            font-size: 12px;
            color: #777;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            font-size: 13px;
        }
        .tab {
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid #ddd;
            color: #555;
            text-decoration: none;
        }
        .tab.active {
            background-color: #222;
            color: #fff;
            border-color: #222;
        }

        main {
            padding: 16px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* --- 캘린더 헤더 --- */
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .month-display {
            font-weight: 600;
        }
        .month-nav {
            display: flex;
            gap: 6px;
        }
        .nav-btn {
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* --- 캘린더 테이블 --- */
        table.calendar {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 12px;
        }
        table.calendar th {
            padding-bottom: 4px;
            font-weight: 500;
            color: #999;
        }
        table.calendar td {
            height: 32px;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            position: relative;
        }
        table.calendar td.disabled {
            color: #ccc;
            cursor: default;
        }
        .day-number {
            display: inline-flex;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
        }
        .day-number.selected {
            background-color: #3b82f6;
            color: #fff;
        }
        .day-number.today {
            border: 1px solid #3b82f6;
        }
        .event-dots {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
        }

        .event-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #3b82f6;
        }

        /* --- 일별 일정 리스트 --- */
        .day-section-title {
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }
        .event-list {
            margin: 8px 0 0;
            padding: 0;
            list-style: none;
            max-height: 220px;
            overflow-y: auto;
        }
        .event-item {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #eee;
            margin-bottom: 6px;
            cursor: pointer;
        }
        .event-item-title {
            font-size: 13px;
            font-weight: 600;
        }
        .event-item-time {
            font-size: 12px;
            color: #777;
            margin-top: 2px;
        }
        .event-item-people {
            font-size: 12px;
            color: #777;
            margin-top: 2px;
        }
        .empty-message {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }

        /* --- 상세 패널 --- */
        .event-detail-section {
            margin-top: 16px;
            padding: 12px 10px 10px;
            border-top: 1px solid #eee;
            background-color: #fafafa;
            border-radius: 12px;
        }
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            margin-bottom: 8px;
        }
        .detail-header button {
            border: none;
            background: none;
            font-size: 12px;
            cursor: pointer;
        }
        .detail-delete {
            color: #ef4444;
        }
        .detail-edit {
            color: #3b82f6;
        }
        .detail-title-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            padding: 0;
            margin-bottom: 4px;
        }
        .detail-title-input:disabled {
            color: #111827;
        }
        .detail-datetime {
            font-size: 12px;
            color: #555;
            white-space: pre-line;
            margin-bottom: 10px;
        }
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 4px 0;
            gap: 8px;
        }
        .detail-label {
            font-size: 12px;
            color: #555;
        }
        .detail-input {
            flex: 1;
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background-color: #fff;
        }
        .detail-input:disabled {
            background-color: #f9fafb;
            color: #6b7280;
        }
        .detail-memo-wrapper {
            margin-top: 6px;
        }
        .detail-memo {
            width: 100%;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            background-color: #fff;
        }
        .detail-memo:disabled {
            background-color: #f9fafb;
            color: #6b7280;
        }
        .detail-edit-actions {
            display: none;
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* --- 일정 생성 폼 --- */
        .event-form-toggle {
            margin-top: 8px;
            text-align: right;
        }
        .event-form-toggle button {
            border: none;
            background-color: #3b82f6;
            color: #fff;
            border-radius: 999px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
        }
        .event-form-container {
            margin-top: 12px;
            padding: 12px;
            border-radius: 14px;
            background-color: #f8fafc;
            border: 1px solid #e5e7eb;
            display: none;
            flex-direction: column;
            gap: 8px;
        }
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .form-row label {
            font-size: 12px;
            color: #555;
        }
        .form-row input,
        .form-row select,
        .form-row textarea {
            font-size: 13px;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .form-row textarea {
            resize: vertical;
            min-height: 60px;
        }
        .form-row-inline {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .form-row-inline label {
            margin-right: 8px;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 4px;
        }
        .btn-secondary {
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }
        .btn-primary {
            border: none;
            background: #3b82f6;
            color: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        footer {
            height: 16px;
        }
    </style>
</head>
<body>
<div class="page"
     th:data-project-id="${projectId}"
     th:data-project-name="${projectName}">
    <header>
        <div class="back-row">
            <a th:href="@{/home/main}">&lt;</a>
        </div>
        <div class="project-title">
            <span th:text="${category}">카테고리</span>
            <h2 th:text="${projectName}">프로젝트 이름</h2>
        </div>

        <div class="tabs">
            <a th:href="@{/project/detail/{id}(id=${projectId})}">게시판</a>
            <a th:href="@{/project/{id}/roles(id=${projectId})}">역할</a>
            <a class="tab active">일정</a>
            <a th:href="@{/project/{id}/roadmap(id=${project.id})}">로드맵</a>
            <a th:href="@{/project/{id}/chatrooms(id=${projectId}, memberId=${memberId})}">대화방</a>
        </div>
    </header>

    <main>
        <!-- 캘린더 헤더 -->
        <section>
            <div class="calendar-header">
                <div class="month-display" id="monthDisplay">2025.11</div>
                <div class="month-nav">
                    <button class="nav-btn" id="prevMonthBtn">&#8249;</button>
                    <button class="nav-btn" id="nextMonthBtn">&#8250;</button>
                </div>
            </div>

            <!-- 캘린더 -->
            <table class="calendar">
                <thead>
                <tr>
                    <th>일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th>토</th>
                </tr>
                </thead>
                <tbody id="calendarBody">
                <!-- JS로 채움 -->
                </tbody>
            </table>
        </section>

        <!-- 선택 날짜 + 일정 리스트 -->
        <section>
            <div class="day-section-title" id="selectedDateLabel">일정을 선택하세요</div>
            <ul class="event-list" id="eventList"></ul>
            <div class="empty-message" id="emptyMessage" style="display:none;">
                등록된 일정이 없습니다.
            </div>

            <!-- 상세 보기 패널 -->
            <section id="eventDetailSection" class="event-detail-section" style="display:none;">
                <div class="detail-header">
                    <button type="button" class="detail-delete" id="deleteEventBtn">삭제</button>
                    <button type="button" class="detail-edit" id="editEventBtn">편집</button>
                </div>

                <input id="detailTitle" class="detail-title-input" type="text" disabled>

                <div class="detail-datetime" id="detailDatetime"></div>

                <div class="detail-row">
                    <span class="detail-label">반복</span>
                    <select id="detailRepeatType" class="detail-input" disabled>
                        <option value="NONE">안 함</option>
                        <option value="DAILY">매일</option>
                        <option value="WEEKLY">매주</option>
                        <option value="BIWEEKLY">2주마다</option>
                        <option value="MONTHLY">매월</option>
                        <option value="YEARLY">매년</option>
                    </select>
                </div>

                <div class="detail-row">
                    <span class="detail-label">알림</span>
                    <select id="detailAlarm" class="detail-input" disabled>
                        <option value="">없음</option>
                        <option value="10">10분 전</option>
                        <option value="60">1시간 전</option>
                        <option value="120">2시간 전</option>
                    </select>
                </div>

                <div class="detail-row">
                    <span class="detail-label">동업자</span>
                    <input id="detailParticipants" class="detail-input" type="text" disabled>
                </div>

                <div class="detail-row">
                    <span class="detail-label">메모</span>
                </div>
                <div class="detail-memo-wrapper">
                    <textarea id="detailMemo" class="detail-memo" rows="3" disabled></textarea>
                </div>

                <div class="detail-edit-actions" id="detailEditActions">
                    <button type="button" class="btn-secondary" id="detailCancelBtn">취소</button>
                    <button type="button" class="btn-primary" id="detailSaveBtn">저장</button>
                </div>
            </section>

            <div class="event-form-toggle">
                <button type="button" id="toggleFormBtn">+ 일정 추가</button>
            </div>

            <!-- 일정 추가 폼 -->
            <form class="event-form-container" id="eventForm">
                <div class="form-row">
                    <label for="title">제목</label>
                    <input id="title" name="title" placeholder="제목" required>
                </div>

                <div class="form-row-inline">
                    <label for="visibleToParticipantsOnly">
                        작성자 + 동업자만 조회 가능
                    </label>
                    <input type="checkbox" id="visibleToParticipantsOnly" name="visibleToParticipantsOnly">
                </div>

                <div class="form-row-inline">
                    <label for="allDay">하루종일</label>
                    <input type="checkbox" id="allDay" name="allDay">
                </div>

                <div class="form-row">
                    <label>시작</label>
                    <input type="datetime-local" id="startDateTime" name="startDateTime">
                </div>

                <div class="form-row">
                    <label>종료</label>
                    <input type="datetime-local" id="endDateTime" name="endDateTime">
                </div>

                <div class="form-row">
                    <label for="repeatType">반복</label>
                    <select id="repeatType" name="repeatType">
                        <option value="NONE">안 함</option>
                        <option value="DAILY">매일</option>
                        <option value="WEEKLY">매주</option>
                        <option value="BIWEEKLY">2주마다</option>
                        <option value="MONTHLY">매월</option>
                        <option value="YEARLY">매년</option>
                    </select>
                </div>

                <div class="form-row">                                          // 다이얼은 프론트에서 작업
                    <label for="alarmOffsetMinutes">알림</label>
                    <select id="alarmOffsetMinutes" name="alarmOffsetMinutes">
                        <option value="">없음</option>
                        <option value="10">10분 전</option>
                        <option value="60">1시간 전</option>
                        <option value="120">2시간 전</option>
                    </select>
                </div>

                <div class="form-row">
                    <label>동업자 (복수 선택)</label>
                    <select id="participantIds" name="participantIds" multiple size="5">
                        <option th:each="m : ${teamMembers}"
                                th:value="${m.id}"
                                th:text="${m.nickname}">
                        </option>
                        <option value="ALL">모두</option>
                    </select>
                </div>

                <div class="form-row">
                    <label for="memo">메모</label>
                    <textarea id="memo" name="memo" placeholder="메모"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelFormBtn">취소</button>
                    <button type="submit" class="btn-primary">추가</button>
                </div>
            </form>
        </section>
    </main>

    <footer></footer>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const page = document.querySelector(".page");
        const projectId = page.dataset.projectId;

        const monthDisplay = document.getElementById("monthDisplay");
        const calendarBody = document.getElementById("calendarBody");
        const selectedDateLabel = document.getElementById("selectedDateLabel");
        const eventList = document.getElementById("eventList");
        const emptyMessage = document.getElementById("emptyMessage");

        const prevMonthBtn = document.getElementById("prevMonthBtn");
        const nextMonthBtn = document.getElementById("nextMonthBtn");

        const toggleFormBtn = document.getElementById("toggleFormBtn");
        const eventForm = document.getElementById("eventForm");
        const cancelFormBtn = document.getElementById("cancelFormBtn");
        const participantSelect = document.getElementById("participantIds");

        // 상세 패널 요소
        const eventDetailSection = document.getElementById("eventDetailSection");
        const detailTitle = document.getElementById("detailTitle");
        const detailDatetime = document.getElementById("detailDatetime");
        const detailRepeatType = document.getElementById("detailRepeatType");
        const detailAlarm = document.getElementById("detailAlarm");
        const detailParticipants = document.getElementById("detailParticipants");
        const detailMemo = document.getElementById("detailMemo");
        const editEventBtn = document.getElementById("editEventBtn");
        const deleteEventBtn = document.getElementById("deleteEventBtn");
        const detailEditActions = document.getElementById("detailEditActions");
        const detailSaveBtn = document.getElementById("detailSaveBtn");
        const detailCancelBtn = document.getElementById("detailCancelBtn");

        let current = new Date();
        let currentYear = current.getFullYear();
        let currentMonth = current.getMonth() + 1; // 1~12
        let selectedDate = null; // '2025-11-07'
        let selectedEvent = null; // 상세 패널에 표시 중인 이벤트

        // ---- 동업자 "모두" 선택 ----
        if (participantSelect) {
            participantSelect.addEventListener("change", function () {
                const allSelected = Array.from(this.selectedOptions)
                    .some(opt => opt.value === "ALL");

                if (allSelected) {
                    Array.from(this.options).forEach(opt => {
                        opt.selected = true;
                    });
                }
            });
        }

        // ---- 캘린더 렌더링 ----
        function renderCalendar(dots = []) {
            calendarBody.innerHTML = "";

            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const firstWeekday = firstDay.getDay(); // 0:일 ~ 6:토
            const daysInMonth = lastDay.getDate();

            monthDisplay.textContent = `${currentYear}.${String(currentMonth).padStart(2, "0")}`;

            const today = new Date();
            const todayStr = [
                today.getFullYear(),
                String(today.getMonth() + 1).padStart(2, "0"),
                String(today.getDate()).padStart(2, "0")
            ].join("-");

            const dotMap = {};
            dots.forEach(d => {
                const dateStr = d.date; // "2025-11-07"
                const count = d.eventCount != null ? d.eventCount : (d.hasEvent ? 1 : 0);
                dotMap[dateStr] = count;
            });

            let day = 1;
            for (let row = 0; row < 6; row++) {
                const tr = document.createElement("tr");
                for (let col = 0; col < 7; col++) {
                    const td = document.createElement("td");

                    const cellIndex = row * 7 + col;
                    if (cellIndex < firstWeekday || day > daysInMonth) {
                        td.classList.add("disabled");
                        tr.appendChild(td);
                        continue;
                    }

                    const dateStr = [
                        currentYear,
                        String(currentMonth).padStart(2, "0"),
                        String(day).padStart(2, "0")
                    ].join("-");

                    const span = document.createElement("span");
                    span.textContent = day;
                    span.classList.add("day-number");

                    if (dateStr === todayStr) span.classList.add("today");
                    if (dateStr === selectedDate) span.classList.add("selected");

                    td.appendChild(span);

                    const eventCount = dotMap[dateStr] || 0;
                    if (eventCount > 0) {
                        const dotsWrapper = document.createElement("div");
                        dotsWrapper.classList.add("event-dots");

                        const dotsToShow = Math.min(eventCount, 4);
                        for (let i = 0; i < dotsToShow; i++) {
                            const dot = document.createElement("div");
                            dot.classList.add("event-dot");
                            dotsWrapper.appendChild(dot);
                        }

                        td.appendChild(dotsWrapper);
                    }

                    td.dataset.date = dateStr;
                    td.addEventListener("click", () => {
                        selectedDate = dateStr;
                        loadDailyEvents(dateStr);
                    });

                    tr.appendChild(td);
                    day++;
                }
                calendarBody.appendChild(tr);
            }
        }

        // ---- 월별 점 정보 로드 ----
        async function loadMonthlyDots() {
            const url =
                `/project/${projectId}/events/api/month?year=${currentYear}&month=${currentMonth}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("월별 조회 실패");
                const dots = await res.json();
                renderCalendar(dots);
            } catch (e) {
                console.error(e);
                renderCalendar([]);
            }
        }

        // ---- 일별 일정 리스트 로드 ----
        async function loadDailyEvents(dateStr) {
            selectedDateLabel.textContent = formatKoreanDateLabel(dateStr);

            const url = `/project/${projectId}/events/api/day?date=${dateStr}`;
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("일별 조회 실패");
                const events = await res.json();

                eventList.innerHTML = "";
                if (events.length === 0) {
                    emptyMessage.style.display = "block";
                    eventDetailSection.style.display = "none";
                    selectedEvent = null;
                } else {
                    emptyMessage.style.display = "none";
                    events.forEach(ev => {
                        const li = document.createElement("li");
                        li.classList.add("event-item");

                        const title = document.createElement("div");
                        title.classList.add("event-item-title");
                        title.textContent = ev.title;

                        const time = document.createElement("div");
                        time.classList.add("event-item-time");
                        time.textContent = formatEventTime(ev);

                        const people = document.createElement("div");
                        people.classList.add("event-item-people");
                        people.textContent = formatPeople(ev);

                        li.appendChild(title);
                        li.appendChild(time);
                        li.appendChild(people);

                        li.addEventListener("click", (e) => {
                            e.stopPropagation();
                            selectedEvent = ev;
                            showEventDetail(ev);
                        });

                        eventList.appendChild(li);
                    });

                    // 첫 번째 일정 자동 선택 (선택된 게 없을 때)
                    if (!selectedEvent && events.length > 0) {
                        selectedEvent = events[0];
                        showEventDetail(events[0]);
                    }
                }

                // 선택 표시 새로 그리기
                loadMonthlyDots();
            } catch (e) {
                console.error(e);
            }
        }

        // ---- 상세 패널 표시 ----
        function showEventDetail(ev) {
            if (!ev) return;
            eventDetailSection.style.display = "block";

            detailTitle.value = ev.title || "";
            detailDatetime.textContent = formatDetailDatetime(ev);
            detailRepeatType.value = ev.repeatType || "NONE";
            detailAlarm.value = ev.alarmOffsetMinutes != null ? String(ev.alarmOffsetMinutes) : "";
            detailParticipants.value = (ev.participantNames || []).join(", ");
            detailMemo.value = ev.memo || "";

            setDetailEditMode(false);
        }

        function setDetailEditMode(isEdit) {
            detailTitle.disabled = !isEdit;
            detailRepeatType.disabled = !isEdit;
            detailAlarm.disabled = !isEdit;
            detailMemo.disabled = !isEdit;

            detailEditActions.style.display = isEdit ? "flex" : "none";
        }

        // ---- 일정 추가 폼 토글 ----
        toggleFormBtn.addEventListener("click", () => {
            eventForm.style.display =
                eventForm.style.display === "flex" ? "none" : "flex";

            if (selectedDate && !document.getElementById("startDateTime").value) {
                document.getElementById("startDateTime").value =
                    selectedDate + "T10:00";
                document.getElementById("endDateTime").value =
                    selectedDate + "T11:00";
            }
        });

        cancelFormBtn.addEventListener("click", () => {
            eventForm.reset();
            eventForm.style.display = "none";
        });

        // ---- 일정 추가 폼 제출 ----
        eventForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const selectedOptions = Array.from(
                participantSelect.selectedOptions
            );

            // "ALL"은 제외하고 실제 멤버만
            const participantIds = selectedOptions
                .filter(o => o.value !== "ALL")
                .map(o => Number(o.value));

            const payload = {
                title: document.getElementById("title").value,
                memo: document.getElementById("memo").value,
                allDay: document.getElementById("allDay").checked,
                startDateTime: document.getElementById("startDateTime").value,
                endDateTime: document.getElementById("endDateTime").value,
                repeatType: document.getElementById("repeatType").value,
                alarmOffsetMinutes:
                    document.getElementById("alarmOffsetMinutes").value || null,
                participantIds: participantIds,
                visibleToParticipantsOnly:
                    document.getElementById("visibleToParticipantsOnly").checked
            };

            try {
                const res = await fetch(`/project/${projectId}/events`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    alert("일정 생성에 실패했습니다.");
                    return;
                }

                const eventId = await res.json();
                console.log("생성된 일정 ID:", eventId);

                eventForm.reset();
                eventForm.style.display = "none";

                if (selectedDate) {
                    await loadDailyEvents(selectedDate);
                } else {
                    await loadMonthlyDots();
                }
            } catch (err) {
                console.error(err);
                alert("일정 생성 중 오류가 발생했습니다.");
            }
        });

        // ---- 상세 편집 / 삭제 ----
        editEventBtn.addEventListener("click", () => {
            if (!selectedEvent) return;
            setDetailEditMode(true);
        });

        detailCancelBtn.addEventListener("click", () => {
            if (!selectedEvent) return;
            showEventDetail(selectedEvent); // 원래 값으로 롤백
        });

        detailSaveBtn.addEventListener("click", async () => {
            if (!selectedEvent) return;

            const payload = {
                // 기존 값 유지 + 수정 가능한 필드만 덮어쓰기
                title: detailTitle.value,
                memo: detailMemo.value,
                allDay: selectedEvent.allDay,
                startDateTime: selectedEvent.startDateTime,
                endDateTime: selectedEvent.endDateTime,
                repeatType: detailRepeatType.value,
                alarmOffsetMinutes: detailAlarm.value || null,
                participantIds: selectedEvent.participantIds || [],
                visibleToParticipantsOnly: selectedEvent.visibleToParticipantsOnly || false
            };

            try {
                const res = await fetch(`/project/${projectId}/events/${selectedEvent.eventId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    alert("일정 수정에 실패했습니다.");
                    return;
                }

                selectedEvent = {
                    ...selectedEvent,
                    title: detailTitle.value,
                    memo: detailMemo.value,
                    repeatType: detailRepeatType.value,
                    alarmOffsetMinutes: detailAlarm.value || null
                };

                // 리스트/캘린더 다시 그리기 (점/텍스트 최신화용)
                if (selectedDate) {
                    await loadDailyEvents(selectedDate);
                } else {
                    await loadMonthlyDots();
                }

                // 상세 패널은 우리가 들고 있는 selectedEvent로 다시 보여주기
                showEventDetail(selectedEvent);
                setDetailEditMode(false);
            } catch (err) {
                console.error(err);
                alert("일정 수정 중 오류가 발생했습니다.");
            }
        });


        deleteEventBtn.addEventListener("click", async () => {
            if (!selectedEvent) return;
            if (!confirm("이 일정을 삭제할까요?")) return;

            try {
                const res = await fetch(`/project/${projectId}/events/${selectedEvent.eventId}`, {
                    method: "DELETE"
                });

                if (!res.ok) {
                    alert("일정 삭제에 실패했습니다.");
                    return;
                }

                selectedEvent = null;
                eventDetailSection.style.display = "none";
                await loadDailyEvents(selectedDate);
            } catch (err) {
                console.error(err);
                alert("일정 삭제 중 오류가 발생했습니다.");
            }
        });

        // ---- 월 이동 버튼 ----
        prevMonthBtn.addEventListener("click", () => {
            currentMonth--;
            if (currentMonth === 0) {
                currentMonth = 12;
                currentYear--;
            }
            loadMonthlyDots();
        });

        nextMonthBtn.addEventListener("click", () => {
            currentMonth++;
            if (currentMonth === 13) {
                currentMonth = 1;
                currentYear++;
            }
            loadMonthlyDots();
        });

        // 초기 렌더
        loadMonthlyDots();

        // 현재 날짜 표시 (예: "7일 목")
        const weekdayNames = ["일", "월", "화", "수", "목", "금", "토"];

        function formatKoreanDateLabel(dateStr) {
            // dateStr: "2025-11-07"
            const [year, month, day] = dateStr.split("-").map(Number);
            const d = new Date(year, month - 1, day);
            const weekday = weekdayNames[d.getDay()];
            return `${day}일 ${weekday}`;
        }

        // ---- 시간 포맷팅 (리스트용) ----
        function formatEventTime(ev) {
            const start = new Date(ev.startDateTime);
            const end = new Date(ev.endDateTime);

            const isSameDay =
                start.getFullYear() === end.getFullYear() &&
                start.getMonth() === end.getMonth() &&
                start.getDate() === end.getDate();

            // 하루종일 + 같은 날짜
            if (ev.allDay && isSameDay) {
                return "하루 종일";
            }

            // 여러 날짜에 걸친 일정: M월 D일 ~ M월 D일
            if (!isSameDay) {
                return `${start.getMonth() + 1}월 ${start.getDate()}일 ~ ${end.getMonth() + 1}월 ${end.getDate()}일`;
            }

            // 하루 일정: 10:00 AM ~ 18:00 PM 형태
            return `${toAMPM(start)} ~ ${toAMPM(end)}`;
        }

        function toAMPM(date) {
            const hours = String(date.getHours()).padStart(2, "0");
            const minutes = String(date.getMinutes()).padStart(2, "0");
            const ampm = Number(hours) >= 12 ? "PM" : "AM";
            return `${hours}:${minutes} ${ampm}`;
        }

        // ---- 상세 날짜/시간 포맷 (상세 패널용) ----
        function formatDetailDatetime(ev) {
            const start = new Date(ev.startDateTime);
            const end = new Date(ev.endDateTime);

            const weekday = weekdayNames[start.getDay()];
            const dateLine = `${start.getFullYear()}년 ${start.getMonth() + 1}월 ${start.getDate()}일 ${weekday}요일`;

            const isSameDay =
                start.getFullYear() === end.getFullYear() &&
                start.getMonth() === end.getMonth() &&
                start.getDate() === end.getDate();

            let timeLine;
            if (ev.allDay && isSameDay) {
                timeLine = "하루 종일";
            } else if (!isSameDay) {
                timeLine = `${start.getMonth() + 1}월 ${start.getDate()}일 ~ ${end.getMonth() + 1}월 ${end.getDate()}일`;
            } else {
                timeLine = `${toAmPmKorean(start)} ~ ${toAmPmKorean(end)}`;
            }

            return `${dateLine}\n${timeLine}`;
        }

        function toAmPmKorean(date) {
            let hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, "0");
            const isPm = hours >= 12;
            const prefix = isPm ? "오후" : "오전";
            hours = hours % 12;
            if (hours === 0) hours = 12;
            return `${prefix} ${hours}:${minutes}`;
        }

        // ---- 사람 정보 포맷팅 ----
        function formatPeople(ev) {
            const creator = ev.creatorName || "작성자";
            const participants = (ev.participantNames || []).join(", ");

            if (!participants) return creator;

            return `${creator} with ${participants}`;
        }
    });
</script>

</body>
</html>
